# مستندات API کیدو

## فهرست
- [احراز هویت](#احراز-هویت)
- [مدیریت جلسات گفتگو](#مدیریت-جلسات-گفتگو)
- [ابزارهای آموزشی](#ابزارهای-آموزشی)
- [پنل کارکنان](#پنل-کارکنان)
- [کدهای خطا](#کدهای-خطا)

## احراز هویت

تمامی درخواست‌ها به API (به جز Login) نیاز به توکن احراز هویت دارند. توکن باید در هدر درخواست به شکل زیر ارسال شود:

```
Authorization: Token YOUR_TOKEN_HERE
```

### ورود به سیستم
`POST /api/v1/accounts/login/`

برای ورود به سیستم و دریافت توکن.

**ورودی:**
```json
{
    "username": "student_user",
    "password": "password123"
}
```

**خروجی موفق:**
```json
{
    "token": "9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b",
    "user": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "username": "student_user",
        "first_name": "سارا",
        "last_name": "دانش‌آموز",
        "role": "STUDENT"
    }
}
```

**خطاهای احتمالی:**
- `401 Unauthorized`: اطلاعات ورود نامعتبر
- `400 Bad Request`: فیلدهای ضروری ارسال نشده‌اند

### خروج از سیستم
`POST /api/v1/accounts/logout/`

برای خروج و باطل کردن توکن فعلی.

**نیازمند توکن:** بله

**خروجی موفق:**
- `204 No Content`

### مشاهده پروفایل کاربری
`GET /api/v1/accounts/me/`

برای دریافت اطلاعات کاربر فعلی.

**نیازمند توکن:** بله

**خروجی موفق:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "student_user",
    "first_name": "سارا",
    "last_name": "دانش‌آموز",
    "role": "STUDENT"
}
```

## مدیریت جلسات گفتگو

### لیست جلسات گفتگو
`GET /api/v1/chat/sessions/`

برای دریافت لیست جلسات گفتگوی کاربر.

**نیازمند توکن:** بله

**خروجی موفق:**
```json
[
    {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "tool": "DARS_YAR",
        "title": "درس یار on علوم تجربی",
        "subject": "علوم تجربی",
        "updated_at": "2025-07-10T12:00:00Z"
    }
]
```

### جزئیات یک جلسه
`GET /api/v1/chat/sessions/{session_id}/`

برای دریافت جزئیات کامل یک جلسه گفتگو به همراه پیام‌ها.

**نیازمند توکن:** بله

**خروجی موفق:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "tool": "DARS_YAR",
    "title": "درس یار on علوم تجربی",
    "messages": [
        {
            "id": "7d793789-c00c-4c91-99fb-89e1ba7562e4",
            "sender_type": "SYSTEM",
            "content": "CONTEXT:\n--- متن از فصل: اتم‌ها ---\nمحتوای فصل...",
            "timestamp": "2025-07-10T12:00:00Z"
        },
        {
            "id": "9d8e3af1-96d4-4c4c-8f9a-2b6a8f5e9c3b",
            "sender_type": "USER",
            "content": "اتم چیست؟",
            "timestamp": "2025-07-10T12:01:00Z"
        },
        {
            "id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
            "sender_type": "AI",
            "content": "اتم کوچک‌ترین ذره...",
            "timestamp": "2025-07-10T12:01:01Z",
            "raw_ai_response": {
                "answer": "اتم کوچک‌ترین ذره...",
                "student_mood": {
                    "emoji": "🤔",
                    "text": "کنجکاو"
                }
            }
        }
    ]
}
```

### ارسال پیام در جلسه
`POST /api/v1/chat/sessions/{session_id}/messages/`

برای ارسال پیام جدید در یک جلسه گفتگو.

**نیازمند توکن:** بله

**ورودی:**
```json
{
    "content": "سوال من در مورد اتم‌ها این است..."
}
```

**خروجی موفق:**
```json
{
    "id": "9d8e3af1-96d4-4c4c-8f9a-2b6a8f5e9c3b",
    "sender_type": "USER",
    "content": "سوال من در مورد اتم‌ها این است...",
    "timestamp": "2025-07-10T12:01:00Z"
}
```

**خطاهای احتمالی:**
- `404 Not Found`: جلسه مورد نظر یافت نشد
- `403 Forbidden`: کاربر به این جلسه دسترسی ندارد
- `400 Bad Request`: محتوای پیام خالی است

## ابزارهای آموزشی

### شروع جلسه درس‌یار
`POST /api/v1/tools/dars-yar/start/`

برای شروع یک جلسه جدید با ابزار درس‌یار.

**نیازمند توکن:** بله

**ورودی:**
```json
{
    "subject_id": "550e8400-e29b-41d4-a716-446655440000",
    "chapter_ids": [
        "7d793789-c00c-4c91-99fb-89e1ba7562e4",
        "9d8e3af1-96d4-4c4c-8f9a-2b6a8f5e9c3b"
    ]
}
```

**خروجی موفق:**
```json
{
    "id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
    "tool": "DARS_YAR",
    "title": "درس یار on علوم تجربی",
    "messages": [
        {
            "id": "7d793789-c00c-4c91-99fb-89e1ba7562e4",
            "sender_type": "SYSTEM",
            "content": "CONTEXT:\n--- متن از فصل: اتم‌ها ---\nمحتوای فصل...",
            "timestamp": "2025-07-10T12:00:00Z"
        }
    ]
}
```

**خطاهای احتمالی:**
- `400 Bad Request`: 
  - درس یا فصل‌های انتخابی نامعتبر هستند
  - فصل‌های انتخابی متعلق به درس انتخاب شده نیستند
  - کاربر به درس انتخابی دسترسی ندارد
- `403 Forbidden`: کاربر اجازه استفاده از این ابزار را ندارد

### شروع جلسه آزمون‌ساز
`POST /api/v1/tools/azmoon-saz/start/`

برای شروع یک جلسه جدید با ابزار آزمون‌ساز.

**نیازمند توکن:** بله

**ورودی:**
```json
{
    "subject_id": "550e8400-e29b-41d4-a716-446655440000",
    "chapter_ids": ["7d793789-c00c-4c91-99fb-89e1ba7562e4"],
    "difficulty": "متوسط",
    "num_questions": 10
}
```

**محدودیت‌های ورودی:**
- `difficulty`: یکی از مقادیر "آسان"، "متوسط" یا "سخت"
- `num_questions`: یکی از مقادیر 5، 10 یا 20

**خروجی موفق:**
```json
{
    "id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
    "tool": "AZMOON_SAZ",
    "title": "آزمون ساز on علوم تجربی",
    "messages": [
        {
            "id": "7d793789-c00c-4c91-99fb-89e1ba7562e4",
            "sender_type": "SYSTEM",
            "content": "CONTEXT:\n--- متن از فصل: اتم‌ها ---\nمحتوای فصل...",
            "timestamp": "2025-07-10T12:00:00Z"
        },
        {
            "id": "9d8e3af1-96d4-4c4c-8f9a-2b6a8f5e9c3b",
            "sender_type": "SYSTEM",
            "content": "بر اساس محتوای ارائه شده، لطفاً 10 سوال چهارگزینه‌ای در سطح دشواری 'متوسط' طراحی کن.",
            "timestamp": "2025-07-10T12:00:01Z"
        },
        {
            "id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
            "sender_type": "AI",
            "content": "بسیار خب! این هم آزمون شما:",
            "timestamp": "2025-07-10T12:00:02Z",
            "raw_ai_response": {
                "questions": [
                    {
                        "question_text": "کدام گزینه درباره اتم درست است؟",
                        "options": ["گزینه 1", "گزینه 2", "گزینه 3", "گزینه 4"],
                        "correct_answer": "گزینه 2"
                    }
                ]
            }
        }
    ]
}
```

### شروع جلسه کنجکاو شو
`POST /api/v1/tools/konjkav-sho/start/`

برای شروع یک جلسه جدید با ابزار کنجکاو شو.

**نیازمند توکن:** بله

**ورودی:**
```json
{
    "subject_id": "550e8400-e29b-41d4-a716-446655440000",
    "initial_topic": "چرا آسمان آبی است؟"
}
```

**خروجی موفق:**
```json
{
    "id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
    "tool": "KONJKAV_SHO",
    "title": "کنجکاو شو on علوم تجربی",
    "messages": [
        {
            "id": "7d793789-c00c-4c91-99fb-89e1ba7562e4",
            "sender_type": "USER",
            "content": "چرا آسمان آبی است؟",
            "timestamp": "2025-07-10T12:00:00Z"
        },
        {
            "id": "9d8e3af1-96d4-4c4c-8f9a-2b6a8f5e9c3b",
            "sender_type": "AI",
            "content": "آسمان به دلیل پراکندگی نور...",
            "timestamp": "2025-07-10T12:00:01Z",
            "raw_ai_response": {
                "explanation": "آسمان به دلیل پراکندگی نور...",
                "follow_up_questions": [
                    "چرا در غروب آسمان قرمز می‌شود؟",
                    "آیا در ماه هم آسمان آبی است؟",
                    "نور چگونه در جو پراکنده می‌شود؟"
                ],
                "student_mood": {
                    "emoji": "🤔",
                    "text": "کنجکاو"
                }
            }
        }
    ]
}
```

### شروع جلسه ترکیب کن
`POST /api/v1/tools/tarkib-kon/start/`

برای شروع یک جلسه جدید با ابزار ترکیب کن.

**نیازمند توکن:** بله

**ورودی:**
```json
{
    "subject_id": "550e8400-e29b-41d4-a716-446655440000",
    "topic": "اهرم‌ها",
    "theme": "ماینکرفت"
}
```

**خروجی موفق:**
```json
{
    "id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
    "tool": "TARKIB_KON",
    "title": "ترکیب کن on علوم تجربی",
    "messages": [
        {
            "id": "7d793789-c00c-4c91-99fb-89e1ba7562e4",
            "sender_type": "USER",
            "content": "موضوع «اهرم‌ها» را در فضا و لحن «ماینکرفت» توضیح بده.",
            "timestamp": "2025-07-10T12:00:00Z"
        }
    ]
}
```

## پنل کارکنان

### لیست کلاس‌ها
`GET /api/v1/academics/classes/`

برای دریافت لیست کلاس‌های مدرسه کارمند.

**نیازمند توکن:** بله  
**نیازمند نقش:** STAFF

**خروجی موفق:**
```json
[
    {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "ششم - الف",
        "grade_level": 6
    }
]
```

### لیست دانش‌آموزان کلاس
`GET /api/v1/academics/classes/{class_id}/students/`

برای دریافت لیست و وضعیت دانش‌آموزان یک کلاس.

**نیازمند توکن:** بله  
**نیازمند نقش:** STAFF

**خروجی موفق:**
```json
[
    {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "full_name": "سارا دانش‌آموز",
        "last_activity_at": "2025-07-10T12:00:00Z",
        "activity_status": "Active",
        "current_mood": {
            "emoji": "🤔",
            "text": "کنجکاو"
        }
    }
]
```

### لیست و فیلتر رویدادها
`GET /api/v1/chat/events/`

برای دریافت لیست رویدادهای دانش‌آموزان مدرسه.

**نیازمند توکن:** بله  
**نیازمند نقش:** STAFF

**پارامترهای Query:**
- `level`: فیلتر بر اساس سطح رویداد (INFO, CONCERN, DANGER)
- `is_resolved`: فیلتر بر اساس وضعیت رسیدگی (true/false)

**خروجی موفق:**
```json
[
    {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "student_name": "سارا دانش‌آموز",
        "overview": "دانش‌آموز از کلمات نگران‌کننده استفاده کرد",
        "emoji": "🚨",
        "level": "DANGER",
        "subject_name": "علوم تجربی",
        "created_at": "2025-07-10T12:00:00Z",
        "is_resolved": false
    }
]
```

### جزئیات رویداد
`GET /api/v1/chat/events/{event_id}/`

برای دریافت جزئیات کامل یک رویداد.

**نیازمند توکن:** بله  
**نیازمند نقش:** STAFF

**خروجی موفق:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "student_name": "سارا دانش‌آموز",
    "overview": "دانش‌آموز از کلمات نگران‌کننده استفاده کرد",
    "emoji": "🚨",
    "level": "DANGER",
    "subject_name": "علوم تجربی",
    "created_at": "2025-07-10T12:00:00Z",
    "is_resolved": false,
    "explanation": "دانش‌آموز در پیام خود از عبارت 'خطرناک' استفاده کرد که نیاز به بررسی دارد.",
    "session_id": "1a2b3c4d-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
    "resolved_by": null
}
```

### تغییر وضعیت رویداد
`PATCH /api/v1/chat/events/{event_id}/`

برای تغییر وضعیت رسیدگی به یک رویداد.

**نیازمند توکن:** بله  
**نیازمند نقش:** STAFF

**ورودی:**
```json
{
    "is_resolved": true
}
```

**خروجی موفق:**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "is_resolved": true,
    "resolved_by": {
        "id": "7d793789-c00c-4c91-99fb-89e1ba7562e4",
        "username": "staff_user"
    },
    ...
}
```

### بازنشانی رمز عبور دانش‌آموز
`POST /api/v1/accounts/students/{student_user_id}/reset-password/`

برای بازنشانی رمز عبور یک دانش‌آموز.

**نیازمند توکن:** بله  
**نیازمند نقش:** STAFF

**ورودی:**
```json
{
    "new_password": "new_secure_password_123"
}
```

**محدودیت‌های ورودی:**
- طول رمز عبور حداقل 8 کاراکتر

**خروجی موفق:**
```json
{
    "message": "رمز عبور دانش‌آموز سارا دانش‌آموز با موفقیت تغییر کرد."
}
```

**خطاهای احتمالی:**
- `404 Not Found`: دانش‌آموز مورد نظر یافت نشد
- `403 Forbidden`: کارمند اجازه تغییر رمز این دانش‌آموز را ندارد
- `400 Bad Request`: رمز عبور انتخابی معتبر نیست

## کدهای خطا

### خطاهای عمومی
- `400 Bad Request`: درخواست نامعتبر
- `401 Unauthorized`: عدم احراز هویت
- `403 Forbidden`: عدم دسترسی
- `404 Not Found`: منبع مورد نظر یافت نشد
- `405 Method Not Allowed`: متد HTTP نامعتبر
- `500 Internal Server Error`: خطای داخلی سرور

### نمونه خطا
```json
{
    "error": "Permission denied.",
    "detail": "You do not have permission to perform this action."
}
```

### نکات مهم
1. تمامی درخواست‌ها باید با `Content-Type: application/json` ارسال شوند.
2. تمامی timestamp‌ها در فرمت UTC هستند.
3. شناسه‌های منابع (id) از نوع UUID هستند.
4. در صورت بروز خطا، همیشه یک پیام خطای معنادار برگردانده می‌شود.
